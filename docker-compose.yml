# docker-compose.yml - # Docker Compose file for FastAPI + MariaDB + phpMyAdmin
#
# What it does
# ubuntu-python: runs FastAPI via uvicorn; mounts your source code for live reload.
# mariadb: persists DB data in a named Docker volume (mariadb_data) so DB survives restarts.
# phpmyadmin: connects to MariaDB on the internal compose network; exposed on host port 8080 (or whatever you set).
# Key behaviors
# depends_on + service_healthy prevents app/phpMyAdmin from starting before DB is ready.
# ./shared:/shared appears inside all containers - simple way to exchange files across services and host.
#
# Version B.1 - 260212
# Updates:
# •	mariadb + phpmyadmin are “infrastructure”
# •	each app is its own service with its own profile
# •	start only one app by choosing a profile
# •	DB data persists in mariadb_data volume



services:
  mariadb:
    image: mariadb:11
    # container_name: mariadb_fastAPI1
    env_file: [.env]
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${MARIADB_PORT}:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./shared:/shared:delegated
      - ./db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 20

  phpmyadmin:
    image: phpmyadmin:latest
    # container_name: phpmyadmin_fastAPI1
    env_file: [.env]
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      PMA_HOST: ${DB_HOST}
      PMA_PORT: ${DB_PORT}
      PMA_ARBITRARY: 0
      UPLOAD_LIMIT: 256M
    ports:
      - "${PHPMYADMIN_PORT}:80"
    volumes:
      - ./shared:/shared:delegated
  
  # -----------------------
  # APP 1 (dev)
  # -----------------------
  app1:
    profiles: ["app1"]
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      target: dev-runtime
      # container_name: fastapi-app1
    env_file: [.env]
    working_dir: /workspace/app1
    environment:
      APP_NAME: app1
    ports:
      - "${FASTAPI_PORT_APP1}:8000"
    volumes:
      - ./workspace:/workspace:delegated
      - ./shared:/shared:delegated
    depends_on:
      mariadb:
        condition: service_healthy
    command: >
      bash -lc "cd /workspace/app1 &&
      exec uvicorn app.main:app --host 0.0.0.0 --port 8000
      --reload --reload-dir /workspace/app1"

  # -----------------------
  # APP 1 (prod)
  # -----------------------
  app1-prod:
    profiles: ["app1-prod"]
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      target: prod-runtime
      # container_name: fastapi-app1-prod
    env_file: [.env]
    working_dir: /workspace/app1
    ports:
      - "${FASTAPI_PORT_APP1}:8000"
    volumes:
      - ./workspace:/workspace:delegated
      - ./shared:/shared:delegated
    depends_on:
      mariadb:
        condition: service_healthy
    command: >
      bash -lc "cd /workspace/app1 &&
      exec gunicorn app.main:app
      -k uvicorn.workers.UvicornWorker
      -b 0.0.0.0:8000
      --workers ${WEB_CONCURRENCY:-2}
      --timeout 60"






  # -----------------------
  # APP 2 (dev)
  # -----------------------
  app2:
    profiles: ["app2"]
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      target: dev-runtime
      # container_name: fastapi-app2
    env_file: [.env]
    working_dir: /workspace/app2
    environment:
      APP_NAME: app2
    ports:
      - "${FASTAPI_PORT_APP2}:8000"
    volumes:
      - ./workspace:/workspace:delegated
      - ./shared:/shared:delegated
    depends_on:
      mariadb:
        condition: service_healthy
    command: >
      bash -lc "cd /workspace/app2 &&
      exec uvicorn app.main:app --host 0.0.0.0 --port 8000
      --reload --reload-dir /workspace/app2"

  # -----------------------
  # APP 2 (prod)
  # -----------------------
  app2-prod:
    profiles: ["app2-prod"]
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      target: prod-runtime
      # container_name: fastapi-app2-prod
    env_file: [.env]
    working_dir: /workspace/app2
    ports:
      - "${FASTAPI_PORT_APP2}:8000"
    volumes:
      - ./workspace:/workspace:delegated
      - ./shared:/shared:delegated
    depends_on:
      mariadb:
        condition: service_healthy
    command: >
      bash -lc "cd /workspace/app2 &&
      exec gunicorn app.main:app
      -k uvicorn.workers.UvicornWorker
      -b 0.0.0.0:8000
      --workers ${WEB_CONCURRENCY:-2}
      --timeout 60"






  # -----------------------
  # APP 3 (dev)
  # -----------------------
  app3:
    profiles: ["app3"]
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      target: dev-runtime
      # container_name: fastapi-app3
    env_file: [.env]
    working_dir: /workspace/app3
    environment:
      APP_NAME: app3
    ports:
      - "${FASTAPI_PORT_APP3}:8000"
    volumes:
      - ./workspace:/workspace:delegated
      - ./shared:/shared:delegated
    depends_on:
      mariadb:
        condition: service_healthy
    command: >
      bash -lc "cd /workspace/app3 &&
      exec uvicorn app.main:app --host 0.0.0.0 --port 8000
      --reload --reload-dir /workspace/app3"

  # -----------------------
  # APP 3 (prod)
  # -----------------------
  app3-prod:
    profiles: ["app3-prod"]
    build:
      context: .
      dockerfile: Dockerfile.ubuntu
      target: prod-runtime
      # container_name: fastapi-app3-prod
    env_file: [.env]
    working_dir: /workspace/app3
    ports:
      - "${FASTAPI_PORT_APP3}:8000"
    volumes:
      - ./workspace:/workspace:delegated
      - ./shared:/shared:delegated
    depends_on:
      mariadb:
        condition: service_healthy
    command: >
      bash -lc "cd /workspace/app3 &&
      exec gunicorn app.main:app
      -k uvicorn.workers.UvicornWorker
      -b 0.0.0.0:8000
      --workers ${WEB_CONCURRENCY:-2}
      --timeout 60"




volumes:
  mariadb_data:

